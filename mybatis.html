<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF" data-link-color="#307FFF" data-content-max-width="1300" data-resizable-sidebar="true" data-sidebar-width="300"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2025-09-11T07:24:52.220057466"><title>mybatis | Mind and Hand</title><script type="application/json" id="virtual-toc-data">[{"id":"-nmg5jl_5","level":0,"title":"测试示例","anchor":"#-nmg5jl_5"},{"id":"mybatis","level":0,"title":"理解Mybatis","anchor":"#mybatis"},{"id":"-nmg5jl_9","level":1,"title":"结构上理解","anchor":"#-nmg5jl_9"},{"id":"configuration","level":2,"title":"Configuration","anchor":"#configuration"},{"id":"environment","level":2,"title":"Environment","anchor":"#environment"},{"id":"mapperregistry","level":2,"title":"MapperRegistry","anchor":"#mapperregistry"},{"id":"mapperproxy","level":2,"title":"MapperProxy","anchor":"#mapperproxy"},{"id":"mappermethod","level":2,"title":"MapperMethod","anchor":"#mappermethod"},{"id":"mappedstatement","level":2,"title":"MappedStatement","anchor":"#mappedstatement"},{"id":"defaultsqlsessionfactory","level":2,"title":"DefaultSqlSessionFactory","anchor":"#defaultsqlsessionfactory"},{"id":"sqlsessionmanager","level":2,"title":"SqlSessionManager","anchor":"#sqlsessionmanager"},{"id":"defaultsqlsession","level":2,"title":"DefaultSqlSession","anchor":"#defaultsqlsession"},{"id":"-nmg5jl_10","level":1,"title":"行为上理解","anchor":"#-nmg5jl_10"},{"id":"sqlsessionfactory","level":2,"title":"创建 SqlSessionFactory","anchor":"#sqlsessionfactory"},{"id":"sqlsession","level":2,"title":"获取 SqlSession","anchor":"#sqlsession"},{"id":"-nmg5jl_199","level":2,"title":"获取接口代理对象","anchor":"#-nmg5jl_199"},{"id":"mapperproxy-mappermethod","level":2,"title":"执行接口里面的方法 MapperProxy MapperMethod","anchor":"#mapperproxy-mappermethod"},{"id":"executor","level":2,"title":"Executor","anchor":"#executor"},{"id":"java-jdbc","level":1,"title":"理解Java对于JDBC事务的封装","anchor":"#java-jdbc"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><link href="static/custom.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="mybatis | Mind and Hand"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Mind and Hand Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/mybatis.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="mybatis | Mind and Hand"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/mybatis.html#webpage",
    "url": "writerside-documentation/mybatis.html",
    "name": "mybatis | Mind and Hand",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Mind and Hand Help"
}</script><!-- End Schema.org --></head><body data-id="mybatis" data-main-title="mybatis" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="develop.md|develop///lang-java.md|java"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Mind and Hand  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="mybatis" id="mybatis.md">mybatis</h1><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_4"><p id="-nmg5jl_7">理解 Mybatis 的源码</p></aside><section class="chapter"><h2 id="-nmg5jl_5" data-toc="-nmg5jl_5">测试示例</h2><div class="code-block" data-lang="java">
@Test
public void testDemo() throws IOException {

    // 获取 SqlSessionFactory
    String resource = &quot;mybatis-config.xml&quot;;
    InputStream inputStream = Resources.getResourceAsStream(resource);
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
       
    // 获取 SqlSession
    SqlSession sqlSession = sqlSessionFactory.openSession();

    // 获取 Mapper 的代理对象
    DemoBeanMapper mapper = sqlSession.getMapper(DemoBeanMapper.class);
    Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
    map.put(&quot;id&quot;, &quot;1&quot;);
        
    // execute sql
    System.out.println(mapper.selectById(map).toString());

    // sqlSession.commit();
    sqlSession.close();
}
</div></section><section class="chapter"><h2 id="mybatis" data-toc="mybatis">理解Mybatis</h2><section class="chapter"><h3 id="-nmg5jl_9" data-toc="-nmg5jl_9">结构上理解</h3><section class="chapter"><h4 id="configuration" data-toc="configuration">Configuration</h4><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_21"><p id="-nmg5jl_23">Mybatis 中 Configuration 更好的理解上将其理解为 配置 + 解析</p></aside><ul class="list _bullet" id="-nmg5jl_22"><li class="list__item" id="-nmg5jl_24"><p id="-nmg5jl_26">存储配置信息</p><ul class="list _bullet" id="-nmg5jl_27"><li class="list__item" id="-nmg5jl_28"><p id="-nmg5jl_30">一系列的<code class="code" id="-nmg5jl_31">boolean</code>变量<code class="code" id="-nmg5jl_32">(safeRowBoundsEnabled,safeResultHandlerEnabled,mapUnderscoreToCamelCase,...)</code> ,用来控制 <code class="code" id="-nmg5jl_33">CURD</code> 的 <code class="code" id="-nmg5jl_34">input</code> 和 <code class="code" id="-nmg5jl_35">output</code></p></li><li class="list__item" id="-nmg5jl_29"><p id="-nmg5jl_36">存储 环境信息 <code class="code" id="-nmg5jl_37">Environment</code></p></li></ul></li><li class="list__item" id="-nmg5jl_25"><p id="-nmg5jl_38">存储解析信息</p><ul class="list _bullet" id="-nmg5jl_39"><li class="list__item" id="-nmg5jl_40"><p id="-nmg5jl_49">通过 MapperRegistry 缓存了 MapperProxyFactory</p></li><li class="list__item" id="-nmg5jl_41"><p id="-nmg5jl_50">存储 InterceptorChain 过滤链</p></li><li class="list__item" id="-nmg5jl_42"><p id="-nmg5jl_51">存储 TypeHandlerRegistry</p></li><li class="list__item" id="-nmg5jl_43"><p id="-nmg5jl_52">存储 TypeAliasRegistry,</p></li><li class="list__item" id="-nmg5jl_44"><p id="-nmg5jl_53">通过 HashMap (<code class="code" id="-nmg5jl_55">Map&lt;String, MappedStatement&gt; mappedStatements</code>) 存储了 <code class="code" id="-nmg5jl_56">MappedStatement</code></p><ul class="list _bullet" id="-nmg5jl_54"><li class="list__item" id="-nmg5jl_57"><p id="-nmg5jl_58">一个 MappedStatement 对应 Mapper.xml 中的一个 <code class="code" id="-nmg5jl_59">INSERT,SELECT,DELETE,UPDATE</code> 的代码片段</p></li></ul></li><li class="list__item" id="-nmg5jl_45"><p id="-nmg5jl_60">通过 HashMap(<code class="code" id="-nmg5jl_61">Map&lt;String, Cache&gt;</code>) 存储了 Mybatis 的缓存</p></li><li class="list__item" id="-nmg5jl_46"><p id="-nmg5jl_62">通过 HashMap(<code class="code" id="-nmg5jl_63">Map&lt;String, ResultMap&gt;</code>) 存储了 Mapper.xml 中 ResultSet 块</p></li><li class="list__item" id="-nmg5jl_47"><p id="-nmg5jl_64">通过 HashMap(<code class="code" id="-nmg5jl_65">Map&lt;String, ParameterMap&gt;</code>) 存储了 Mapper.xml 中 ParameterMap 块</p></li><li class="list__item" id="-nmg5jl_48"><p id="-nmg5jl_66">通过 HashMap(<code class="code" id="-nmg5jl_67">Map&lt;String, KeyGenerator&gt;</code>) 存储了KeyGenerator</p></li></ul></li></ul></section><section class="chapter"><h4 id="environment" data-toc="environment">Environment</h4><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_68"><p id="-nmg5jl_70">Mybatis定义的环境,用途理解: 这个环境和JDBC有紧密的关联</p></aside><ul class="list _bullet" id="-nmg5jl_69"><li class="list__item" id="-nmg5jl_71"><p id="-nmg5jl_73">包含了 TransactionFactory,用来创建事务</p></li><li class="list__item" id="-nmg5jl_72"><p id="-nmg5jl_74">包含了 DataSource,用来获取连接</p></li></ul></section><section class="chapter"><h4 id="mapperregistry" data-toc="mapperregistry">MapperRegistry</h4><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_75"><p id="-nmg5jl_77">从多类框架源码中可以发现,一般<code class="code" id="-nmg5jl_78">Registry</code>结尾的都是在框架的初始化阶段将需要的信息存储进去</p></aside><ul class="list _bullet" id="-nmg5jl_76"><li class="list__item" id="-nmg5jl_79"><p id="-nmg5jl_81">引用了 <code class="code" id="-nmg5jl_82">Configuration</code></p></li><li class="list__item" id="-nmg5jl_80"><p id="-nmg5jl_83">一对一映射了 Class 和 MapperProxyFactory</p><ul class="list _bullet" id="-nmg5jl_84"><li class="list__item" id="-nmg5jl_85"><p id="-nmg5jl_87"><code class="code" id="-nmg5jl_88">Class</code>: Java代码书写的 Mapper 接口</p></li><li class="list__item" id="-nmg5jl_86"><p id="-nmg5jl_89"><code class="code" id="-nmg5jl_90">MapperProxyFactory</code>: 生成动态代理抽象的工厂,用来生成 <code class="code" id="-nmg5jl_91">MapperProxy</code></p></li></ul></li></ul></section><section class="chapter"><h4 id="mapperproxy" data-toc="mapperproxy">MapperProxy</h4><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_92"><p id="-nmg5jl_95">真正执行Mapper接口方法的关键类</p></aside><ul class="list _bullet" id="-nmg5jl_93"><li class="list__item" id="-nmg5jl_96"><p id="-nmg5jl_99">包含了 <code class="code" id="-nmg5jl_100">SqlSession sqlSession</code>: 一次JDBC执行抽象Session</p></li><li class="list__item" id="-nmg5jl_97"><p id="-nmg5jl_101">包含了 <code class="code" id="-nmg5jl_102">Class&lt;T&gt; mapperInterface</code>: 对应了 Java编写的Mapper接口</p></li><li class="list__item" id="-nmg5jl_98"><p id="-nmg5jl_103">包含了 <code class="code" id="-nmg5jl_104">Map&lt;Method, MapperMethod&gt; methodCache</code>: 接口里的每个方法对应了 MapperMethod</p></li></ul><p id="-nmg5jl_94">创建Mapper接口代理对象的<span class="control" id="-nmg5jl_105">核心是 MapperProxy 实现了 InvocationHandler</span></p></section><section class="chapter"><h4 id="mappermethod" data-toc="mappermethod">MapperMethod</h4><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_106"><p id="-nmg5jl_110">从名字就可看出 和 Java的Mapper和Xml的Mapper 有关</p></aside><ul class="list _bullet" id="-nmg5jl_107"><li class="list__item" id="-nmg5jl_111"><p id="-nmg5jl_113">包含了 <code class="code" id="-nmg5jl_115">SqlCommand command</code> <code class="code" id="-nmg5jl_116">SqlCommand</code> 是 <code class="code" id="-nmg5jl_117">MappedStatement</code> 的引用映射, <code class="code" id="-nmg5jl_118">SqlCommand</code> 主要记录了 id 和 type</p><ul class="list _bullet" id="-nmg5jl_114"><li class="list__item" id="-nmg5jl_119"><p id="-nmg5jl_121">id 的 作用是从Configuration缓存中找到内容</p></li><li class="list__item" id="-nmg5jl_120"><p id="-nmg5jl_122">type是CURD的类型，在真实执行的时候再分发一次</p></li></ul></li><li class="list__item" id="-nmg5jl_112"><p id="-nmg5jl_123">包含了 <code class="code" id="-nmg5jl_125">MethodSignature method</code>, <code class="code" id="-nmg5jl_126">MethodSignature</code> 是对接口方法的抽象</p><ul class="list _bullet" id="-nmg5jl_124"><li class="list__item" id="-nmg5jl_127"><p id="-nmg5jl_129">枚举了返回类型，用boolean表示选择，记录下返回的类类型</p></li><li class="list__item" id="-nmg5jl_128"><p id="-nmg5jl_130">引用参数处理器</p></li></ul></li></ul><p id="-nmg5jl_108">Mapper接口方法的唯一定义 <code class="code" id="-nmg5jl_131">MapperMethod = Mapper.class + Mapper.method()</code></p><p id="-nmg5jl_109"><span class="control" id="-nmg5jl_132">MapperMethod在整个Mybatis框架中关联了 Java的接口 和 Xml文件的标签</span></p></section><section class="chapter"><h4 id="mappedstatement" data-toc="mappedstatement">MappedStatement</h4><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_133"><p id="-nmg5jl_136">与书写的Mapper.xml文件相关</p></aside><p id="-nmg5jl_134">对于某个 <code class="code" id="-nmg5jl_137">XXXMapper.xml</code></p><ul class="list _bullet" id="-nmg5jl_135"><li class="list__item" id="-nmg5jl_138"><p id="-nmg5jl_140">其中一定要包含namespace, 指向了Java代码中Mapper的接口</p></li><li class="list__item" id="-nmg5jl_139"><p id="-nmg5jl_141">对于 <code class="code" id="-nmg5jl_142">SELCET|INSERT|UPDATE|DELETE</code> ,每一块儿解析成 <code class="code" id="-nmg5jl_143">MappedStatement</code></p></li></ul></section><section class="chapter"><h4 id="defaultsqlsessionfactory" data-toc="defaultsqlsessionfactory">DefaultSqlSessionFactory</h4><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_144"><p id="-nmg5jl_146">从多类框架源码中可以发现, 一般<code class="code" id="-nmg5jl_147">Factory</code>结尾的都是用来生成对象使用的,所以这个是用来产生SqlSession的</p></aside><ul class="list _bullet" id="-nmg5jl_145"><li class="list__item" id="-nmg5jl_148"><p id="-nmg5jl_150">引用了 <code class="code" id="-nmg5jl_152">Configuration</code></p><ul class="list _bullet" id="-nmg5jl_151"><li class="list__item" id="-nmg5jl_153"><p id="-nmg5jl_154">深层理解 : 引用了 <code class="code" id="-nmg5jl_155">Environment</code></p></li></ul></li><li class="list__item" id="-nmg5jl_149"><p id="-nmg5jl_156"><code class="code" id="-nmg5jl_157">implements SqlSessionFactory</code></p></li></ul></section><section class="chapter"><h4 id="sqlsessionmanager" data-toc="sqlsessionmanager">SqlSessionManager</h4><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_158"><p id="-nmg5jl_160">关键是自己定义的方法</p></aside><ul class="list _bullet" id="-nmg5jl_159"><li class="list__item" id="-nmg5jl_161"><p id="-nmg5jl_166">引用了 <code class="code" id="-nmg5jl_167">Configuration</code></p></li><li class="list__item" id="-nmg5jl_162"><p id="-nmg5jl_168"><code class="code" id="-nmg5jl_169">implements SqlSessionFactory</code>, 通过观察成员变量存在 <code class="code" id="-nmg5jl_170">SqlSessionFactory sqlSessionFactory</code> ,说明这里是代理</p></li><li class="list__item" id="-nmg5jl_163"><p id="-nmg5jl_171"><code class="code" id="-nmg5jl_172">implements SqlSession</code>, 表明 <code class="code" id="-nmg5jl_173">SqlSessionManager</code> 本身就是个SqlSession</p></li><li class="list__item" id="-nmg5jl_164"><p id="-nmg5jl_174">成员变量声明了 <code class="code" id="-nmg5jl_175">ThreadLocal&lt;SqlSession&gt; localSqlSession</code>, 一般和多线程相关</p></li><li class="list__item" id="-nmg5jl_165"><p id="-nmg5jl_176">综上从结构上理解, <code class="code" id="-nmg5jl_177">SqlSessionManager</code> 作为 <code class="code" id="-nmg5jl_178">Factory</code> 可以产生 <code class="code" id="-nmg5jl_179">SqlSession</code>, 作为 <code class="code" id="-nmg5jl_180">SqlSession</code> 可以执行, 因为其又包含了 <code class="code" id="-nmg5jl_181">ThreadLocal</code> ,所以这个<code class="code" id="-nmg5jl_182">SqlSessionManager</code>暂时理解为是在多个Java方法有SQL调用的时候控制事务使用的</p></li></ul></section><section class="chapter"><h4 id="defaultsqlsession" data-toc="defaultsqlsession">DefaultSqlSession</h4><p id="-nmg5jl_183">从<code class="code" id="-nmg5jl_186">SqlSession</code>接口上看, 提供了通用的curd方法, 一般不直接调用。</p><p id="-nmg5jl_184">提供了<code class="code" id="-nmg5jl_187">getMapper()</code>的方法, 这个就是Mybatis提供的ORM</p><ul class="list _bullet" id="-nmg5jl_185"><li class="list__item" id="-nmg5jl_188"><p id="-nmg5jl_190">引用了 <code class="code" id="-nmg5jl_191">Configuration</code>, 等价于引用了 <code class="code" id="-nmg5jl_192">Environment</code>, 等价于可以获取到 <code class="code" id="-nmg5jl_193">DataSource</code> 和 <code class="code" id="-nmg5jl_194">Transaction</code></p></li><li class="list__item" id="-nmg5jl_189"><p id="-nmg5jl_195">定义了执行器: <code class="code" id="-nmg5jl_196">Executor executor</code> ,真实的JDBC调用封装在这个里面</p></li></ul></section></section><section class="chapter"><h3 id="-nmg5jl_10" data-toc="-nmg5jl_10">行为上理解</h3><section class="chapter"><h4 id="sqlsessionfactory" data-toc="sqlsessionfactory">创建 SqlSessionFactory</h4><div class="code-block" data-lang="java">
SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
</div><p id="-nmg5jl_203">理解 : <code class="code" id="-nmg5jl_214">SqlSessionFactory</code> 是最终产生 <code class="code" id="-nmg5jl_215">SqlSession</code> 的地方,在创建 <code class="code" id="-nmg5jl_216">SqlSessionFactory</code> 的时候,需要抓住的关键点是在创建过程中基于哪些外部配置文件创建了内部的配置项</p><p id="-nmg5jl_204">这些内部的配置项(<code class="code" id="-nmg5jl_217">Configuration</code>和<code class="code" id="-nmg5jl_218">Environment</code> )是内部逻辑读取外部配置并构建,从<code class="code" id="-nmg5jl_219">SqlSessionFactory</code>的 <code class="code" id="-nmg5jl_220">openSession()</code>方法上可以看出内部的配置是不需要暴露出来的</p><p id="-nmg5jl_205"><span class="emphasis" id="-nmg5jl_221"><span class="control" id="-nmg5jl_222">小结:</span> 这种设计是大部分框架的设计思路,屏蔽不必要的配置细节,通用化配置过程</span></p><p id="-nmg5jl_206">创建 <code class="code" id="-nmg5jl_223">SqlSessionFactory</code> 的内部有个读取xml文件并解析的工具 <code class="code" id="-nmg5jl_224">XMLConfigBuilder</code>， 这个类继承自 <code class="code" id="-nmg5jl_225">BaseBuilder</code>。 <code class="code" id="-nmg5jl_226">BaseBuilder</code></p><ul class="list _bullet" id="-nmg5jl_207"><li class="list__item" id="-nmg5jl_227"><p id="-nmg5jl_229">声明了 <code class="code" id="-nmg5jl_230">Configuration,TypeAliasRegistry,TypeHandlerRegistry</code> ，关键修饰 <code class="code" id="-nmg5jl_231">protected</code> ,说明子类可以直接使用</p></li><li class="list__item" id="-nmg5jl_228"><p id="-nmg5jl_232"><code class="code" id="-nmg5jl_233">TypeAliasRegistry</code> 和 <code class="code" id="-nmg5jl_234">TypeHandlerRegistry</code> 是引用的 <code class="code" id="-nmg5jl_235">Configuration</code> 自身包含的</p></li></ul><p id="-nmg5jl_208">Mybatis自身规划了很多 <code class="code" id="-nmg5jl_236">Builder</code> (查看 BaseBuilder的继承) 去解析各类配置并存储到 <code class="code" id="-nmg5jl_237">Configuration</code> 中</p><p id="-nmg5jl_209">对于Mapper接口和Mapper.xml文件的解析是在解析Xml文件中的<code class="code" id="-nmg5jl_238">&lt;mapper&gt;</code>标签再次细化</p><ul class="list _bullet" id="-nmg5jl_210"><li class="list__item" id="-nmg5jl_239"><p id="-nmg5jl_240">细化出 <code class="code" id="-nmg5jl_241">MapperProxy</code> <code class="code" id="-nmg5jl_242">MapperMethod</code> <code class="code" id="-nmg5jl_243">MapperStatement</code></p></li></ul><p id="-nmg5jl_211"><span class="emphasis" id="-nmg5jl_244"><span class="control" id="-nmg5jl_245">Q &amp; A :</span></span></p><p id="-nmg5jl_212"><span class="control" id="-nmg5jl_246"><code class="code" id="-nmg5jl_247">Q:</code></span> Mybatis是屏蔽不必要的配置细节,通用化配置过程的？</p><p id="-nmg5jl_213"><span class="control" id="-nmg5jl_248"><code class="code" id="-nmg5jl_251">A:</code></span> Mybatis提供一个XML配置文件,通过读取XML配置文件,初始化了相应的<code class="code" id="-nmg5jl_249">Configuration</code>和<code class="code" id="-nmg5jl_250">Environment</code></p></section><section class="chapter"><h4 id="sqlsession" data-toc="sqlsession">获取 SqlSession</h4><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_252"><p id="-nmg5jl_256">sqlSessionFactory.openSession()</p></aside><p id="-nmg5jl_253">与Datasource以及Transaction相关</p><p id="-nmg5jl_254">SqlSession 本身的抽象是对 JDBC 连接以及执行的抽象聚合</p><ul class="list _bullet" id="-nmg5jl_255"><li class="list__item" id="-nmg5jl_257"><p id="-nmg5jl_259">引用了<code class="code" id="-nmg5jl_261">Configuration</code>本质上可以传递了初始化的缓存数据，关键是使用 <code class="code" id="-nmg5jl_262">Configuration</code> 中的 <code class="code" id="-nmg5jl_263">Environment</code> 数据</p><ul class="list _bullet" id="-nmg5jl_260"><li class="list__item" id="-nmg5jl_264"><p id="-nmg5jl_266">从上面的结构可以了解， <code class="code" id="-nmg5jl_267">Environment</code>主要包含了 <code class="code" id="-nmg5jl_268">TransactionFactory</code> 和 <code class="code" id="-nmg5jl_269">DataSource</code></p></li><li class="list__item" id="-nmg5jl_265"><p id="-nmg5jl_270">在构建 <code class="code" id="-nmg5jl_271">SqlSession</code> 的时候 构建了 <code class="code" id="-nmg5jl_272">Executor</code> 包含了 <code class="code" id="-nmg5jl_273">Transaction</code></p></li></ul></li><li class="list__item" id="-nmg5jl_258"><p id="-nmg5jl_274">真正的SQL执行是在Executor中</p></li></ul></section><section class="chapter"><h4 id="-nmg5jl_199" data-toc="-nmg5jl_199">获取接口代理对象</h4><p id="-nmg5jl_275">Proxy.newProxyInstance: JDK的动态代理</p><p id="-nmg5jl_276">对于Mapper而言,无论是接口Mapper还是文件XMLMapper,都被抽象成了MapperProxy</p><p id="-nmg5jl_277">执行细节的抽象就是MapperMethod</p></section><section class="chapter"><h4 id="mapperproxy-mappermethod" data-toc="mapperproxy-mappermethod">执行接口里面的方法 MapperProxy MapperMethod</h4><p id="-nmg5jl_278">这里是分发执行就是Mapper接口方法的关键</p><p id="-nmg5jl_279"><span class="control" id="-nmg5jl_286">MapperProxy</span></p><p id="-nmg5jl_280">观察<code class="code" id="-nmg5jl_287">MapperProxy</code>真实的调用思路</p><ul class="list _bullet" id="-nmg5jl_281"><li class="list__item" id="-nmg5jl_288"><p id="-nmg5jl_290">从 <code class="code" id="-nmg5jl_291">Map&lt;Method, MapperMethod&gt; methodCache</code> 获取到 Java的Mapper接口映射的MapperMethod方法</p></li><li class="list__item" id="-nmg5jl_289"><p id="-nmg5jl_292">由 <code class="code" id="-nmg5jl_294">MapperMethod</code> 中的 <code class="code" id="-nmg5jl_295">Object execute(SqlSession sqlSession, Object[] args)</code> 这个方法去执行JDBC逻辑</p><ul class="list _bullet" id="-nmg5jl_293"><li class="list__item" id="-nmg5jl_296"><p id="-nmg5jl_299">方法的入参 <code class="code" id="-nmg5jl_300">SqlSession sqlSession</code>, 与Sql执行和事务有关</p></li><li class="list__item" id="-nmg5jl_297"><p id="-nmg5jl_301">方法的入参 <code class="code" id="-nmg5jl_302">Object[] args</code>, 对于接口方法里的参数，Mybatis会将其转换成完整逻辑需要的参数</p></li><li class="list__item" id="-nmg5jl_298"><p id="-nmg5jl_303">方法的出参 用 <code class="code" id="-nmg5jl_305">Object</code> 接收，对应 <code class="code" id="-nmg5jl_306">InvocationHandler</code> 中 <code class="code" id="-nmg5jl_307">invoke</code> 的返回</p><ul class="list _bullet" id="-nmg5jl_304"><li class="list__item" id="-nmg5jl_308"><p id="-nmg5jl_312">对于出参，在JDBC中，返回的结果类型是可枚举的, 所以对每种返回的结果做好映射转换即可</p></li><li class="list__item" id="-nmg5jl_309"><p id="-nmg5jl_313"><code class="code" id="-nmg5jl_314">INSERT,UPDATE,DELETE</code> 一般返回影响的行数</p></li><li class="list__item" id="-nmg5jl_310"><p id="-nmg5jl_315"><code class="code" id="-nmg5jl_316">SELECT</code> 返回的基于 <code class="code" id="-nmg5jl_317">ResultSet</code> 可以转换为 单个对象 或者 对象集合</p></li><li class="list__item" id="-nmg5jl_311"><p id="-nmg5jl_318">如果本身接口方法是 <code class="code" id="-nmg5jl_319">void</code> 没有返回值, <code class="code" id="-nmg5jl_320">return null</code> 即可</p></li></ul></li></ul></li></ul><p id="-nmg5jl_282"><span class="control" id="-nmg5jl_321">MapperMethod</span></p><p id="-nmg5jl_283">对外暴露的执行方法 <code class="code" id="-nmg5jl_322">Object execute(SqlSession sqlSession, Object[] args)</code></p><p id="-nmg5jl_284">方法执行逻辑</p><ul class="list _bullet" id="-nmg5jl_285"><li class="list__item" id="-nmg5jl_323"><p id="-nmg5jl_327">枚举 <code class="code" id="-nmg5jl_329">SqlCommand</code> 的类型(<code class="code" id="-nmg5jl_330">INSERT|UPDATE|DELETE|SELECT|FLUSH</code>), 分发执行类型</p><ul class="list _bullet" id="-nmg5jl_328"><li class="list__item" id="-nmg5jl_331"><p id="-nmg5jl_332"><code class="code" id="-nmg5jl_333">SELECT</code> 的执行又细化了 <code class="code" id="-nmg5jl_334">returnMany</code> <code class="code" id="-nmg5jl_335">returnMap</code> <code class="code" id="-nmg5jl_336">returnsCursor</code> <code class="code" id="-nmg5jl_337">returnOne</code></p></li></ul></li><li class="list__item" id="-nmg5jl_324"><p id="-nmg5jl_338">对于影响行数的返回单独处理, (<code class="code" id="-nmg5jl_339">int|Integer|long|Long|boolean|Boolean</code>) boolean是业务封装</p></li><li class="list__item" id="-nmg5jl_325"><p id="-nmg5jl_340">对于接口方法为<code class="code" id="-nmg5jl_341">void</code>的处理是最简单的, <code class="code" id="-nmg5jl_342">return null</code>即可、</p></li><li class="list__item" id="-nmg5jl_326"><p id="-nmg5jl_343">真实的执行还是由<code class="code" id="-nmg5jl_345">SqlSession</code>来执行的， <code class="code" id="-nmg5jl_346">SqlSession</code>在框架中是距离JDBC最近的抽象封装</p><ul class="list _bullet" id="-nmg5jl_344"><li class="list__item" id="-nmg5jl_347"><p id="-nmg5jl_348"><code class="code" id="-nmg5jl_349">SqlSession</code> 执行的本质是 <code class="code" id="-nmg5jl_350">Executor</code> <code class="code" id="-nmg5jl_351">&lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter, RowBounds rowBounds)</code></p></li></ul></li></ul></section><section class="chapter"><h4 id="executor" data-toc="executor">Executor</h4><p id="-nmg5jl_352">真正执行JDBC操作的入口</p></section></section><section class="chapter"><h3 id="java-jdbc" data-toc="java-jdbc">理解Java对于JDBC事务的封装</h3><aside class="prompt" data-type="tip" data-title="" id="-nmg5jl_353"><p id="-nmg5jl_355">可以扩展思考到Spring的事务设计</p></aside><p id="-nmg5jl_354">Transaction的设计</p></section></section><div class="last-modified">11 September 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="java-design.html" class="navigation-links__prev">design</a><a href="spring.html" class="navigation-links__next">spring</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>